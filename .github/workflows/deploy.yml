name: Deploy Azure Resources and App

on:
  push:
    branches:
      - main # Trigger on push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Log in to Azure
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Step 3: Deploy Bicep template
    - name: Deploy Bicep file
      run: |
        az deployment group create \
          --resource-group BCSAI2024-DEVOPS-STUDENTS-A-DEV \
          --template-file main.bicep \
          --parameters \
            containerRegistryName='sperillaContainerRegistry' \
            appServicePlanName='sperillaAppServicePlan' \
            webAppName='sperillaWebApp' \
            location='westeurope' \
          --name main-$(date +%s)

  build-and-push:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Log in to Azure
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Step 3: Log in to Azure Container Registry
    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    # Step 4: Set image version
    - name: Set image version
      id: image-version
      run: echo "::set-output name=version::$(echo ${GITHUB_REF#refs/heads/})-$(date +'%Y.%m.%d.%H.%M')"

    # Step 5: Build and push Docker image
    - name: Build and push image
      working-directory: ./app # Adjust the path to your Dockerfile if needed
      run: |
        docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/sperillaimage:${{ steps.image-version.outputs.version }}
        docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/sperillaimage:${{ github.ref_name }}-latest
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/sperillaimage:${{ steps.image-version.outputs.version }}
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/sperillaimage:${{ github.ref_name }}-latest

  deploy-webapp:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
    # Step 1: Log in to Azure
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Step 2: Deploy Docker image to Azure Web App
    - name: Deploy Docker image to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: sperillaWebApp
        images: ${{ secrets.REGISTRY_LOGIN_SERVER }}/sperillaimage:${{ github.ref_name }}-latest
